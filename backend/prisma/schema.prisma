generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  password      String
  name          String?
  plan          Plan          @default(FREE)
  maxSessions   Int           @default(2)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  apiKeys       ApiKey[]
  sessions      Session[]
  webhooks      Webhook[]
  usageLogs     UsageLog[]
  settings      UserSettings?
}

model ApiKey {
  id            String    @id @default(uuid())
  key           String    @unique
  name          String
  userId        String
  isActive      Boolean   @default(true)
  lastUsedAt    DateTime?
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
}

model Session {
  id            String        @id @default(uuid())
  userId        String
  name          String
  phone         String?
  status        SessionStatus @default(INITIALIZING)
  qrCode        String?       @db.Text
  retryCount    Int           @default(0)
  lastActive    DateTime?
  errorMessage  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([userId])
  @@index([status])
}

model Message {
  id            String        @id @default(uuid())
  sessionId     String
  to            String
  body          String        @db.Text
  mediaUrl      String?
  type          MessageType   @default(TEXT)
  status        MessageStatus @default(QUEUED)
  externalId    String?
  errorMessage  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  session       Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
}

model Webhook {
  id            String    @id @default(uuid())
  userId        String
  url           String
  events        String[]
  secret        String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UsageLog {
  id            String    @id @default(uuid())
  userId        String
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int
  ip            String?
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model UserSettings {
  id                      String   @id @default(uuid())
  userId                  String   @unique

  // Message throttling
  minDelayBetweenMsgs     Int      @default(3000)
  maxDelayBetweenMsgs     Int      @default(7000)
  maxMsgsPerMinute        Int      @default(12)
  maxMsgsPerHour          Int      @default(200)
  maxMsgsPerDay           Int      @default(1000)

  // Behavioral simulation
  typingDelay             Boolean  @default(true)
  typingDurationMs        Int      @default(2000)
  onlinePresence          Boolean  @default(true)
  readReceipts            Boolean  @default(true)

  // Session safety
  maxNewChatsPerDay       Int      @default(50)
  cooldownAfterBurst      Int      @default(30000)
  burstThreshold          Int      @default(10)
  autoReconnect           Boolean  @default(true)
  maxReconnectAttempts    Int      @default(5)

  // Warning acknowledged
  riskAcknowledged        Boolean  @default(false)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SessionStatus {
  INITIALIZING
  QR_READY
  CONNECTED
  DISCONNECTED
  FAILED
  TERMINATED
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
}

enum MessageStatus {
  QUEUED
  PROCESSING
  SENT
  DELIVERED
  READ
  FAILED
}
