# ══════════════════════════════════════════════════════════════════════════════
# WhatsApp Session Provider — Production Docker Compose
# ══════════════════════════════════════════════════════════════════════════════
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. docker compose build
#   3. docker compose up -d
# ══════════════════════════════════════════════════════════════════════════════

services:
  # ─── Backend API ────────────────────────────────────────────────────────
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: wp-api
    restart: unless-stopped
    ports:
      - '${API_PORT:-7000}:4000'
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DATABASE_URL=${DATABASE_URL}
      - DIRECT_URL=${DIRECT_URL}
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - WA_SESSION_PATH=/app/wa-sessions
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - WA_DEFAULT_MIN_DELAY=3000
      - WA_DEFAULT_MAX_DELAY=7000
      - WA_DEFAULT_MAX_MSG_PER_MIN=12
      - WA_DEFAULT_MAX_MSG_PER_HOUR=200
      - WA_DEFAULT_MAX_MSG_PER_DAY=1000
    volumes:
      - wa-sessions:/app/wa-sessions
      - logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ 'CMD', 'wget', '-qO-', 'http://localhost:4000/health' ]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - app-network

  # ─── Redis ──────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: wp-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: [ 'CMD', 'redis-cli', 'ping' ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - app-network

  # ─── Frontend (Next.js) ────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:7000/api/v1}
    container_name: wp-frontend
    restart: unless-stopped
    ports:
      - '${FRONTEND_PORT:-7500}:3000'
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app-network
  # ─── (Optional) PostgreSQL — uncomment to run a self-contained DB ─────
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: wp-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #     POSTGRES_DB: ${POSTGRES_DB:-wp_sessions}
  #   ports:
  #     - '5432:5432'
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ['CMD-SHELL', 'pg_isready -U postgres']
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

volumes:
  wa-sessions:
  redis-data:
  logs:
    # postgres-data:

networks:
  app-network:
    driver: bridge
